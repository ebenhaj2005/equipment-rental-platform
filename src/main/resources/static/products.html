<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Rental - Catalogus</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <h1 class="logo"><a href="index.html">Equipment Rental</a></h1>
        <div class="nav-links" id="navLinks">
            <a href="index.html">Home</a>
            <a href="products.html">Catalogus</a>
            <a href="cart.html">Winkelwagen (<span id="cartCount">0</span>)</a>
            <a href="orders.html">Mijn Verhuren</a>
            <button onclick="logout()" id="logoutBtn" style="display:none;">Logout</button>
            <a href="login.html" id="loginLink">Login</a>
        </div>
    </div>
</nav>

<div class="container">
    <h2>Catalogus</h2>

    <div class="filters">
        <button onclick="filterByCategory(null)" class="filter-btn active" data-category="all">Alle</button>
        <button onclick="filterByCategory(1)" class="filter-btn" data-category="1">Kabels</button>
        <button onclick="filterByCategory(2)" class="filter-btn" data-category="2">Verlichting</button>
        <button onclick="filterByCategory(3)" class="filter-btn" data-category="3">Controlepanelen</button>
    </div>

    <div id="productsList" class="products-grid">
        <!-- Products worden hier geladen via JavaScript -->
    </div>
</div>

<script src="app.js"></script>
<script>
    let currentFilter = null;

    // Check URL parameters for category filter
    const urlParams = new URLSearchParams(window.location.search);
    const categoryParam = urlParams.get('category');
    if (categoryParam) {
        currentFilter = parseInt(categoryParam);
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-category') == categoryParam) {
                btn.classList.add('active');
            }
        });
    }

    async function loadProducts() {
        try {
            let url = `${API_BASE}/products`;
            if (currentFilter) {
                url = `${API_BASE}/products/category/${currentFilter}`;
            }

            const response = await fetch(url, { credentials: 'include' });
            const products = await response.json();

            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';

            if (products.length === 0) {
                productsList.innerHTML = '<p>Geen producten gevonden</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                    <div class="product-price">â‚¬${product.rentalPrice.toFixed(2)}/dag</div>
                    <div class="product-quantity">Beschikbaar: ${product.quantity}</div>
                    <form class="add-to-cart-form" onsubmit="addToCart(event, ${product.id}, ${product.quantity})">
                        <label>Aantal:</label>
                        <input type="number" name="quantity" min="1" max="${product.quantity}" value="1" required>
                        <label>Startdatum:</label>
                        <input type="date" name="startDate" required>
                        <label>Einddatum:</label>
                        <input type="date" name="endDate" required>
                        <button type="submit" class="btn-primary">In Winkelwagen</button>
                    </form>
                `;
                productsList.appendChild(productCard);
            });
        } catch (error) {
            console.error('Failed to load products:', error);
            document.getElementById('productsList').innerHTML = '<p>Fout bij laden van producten</p>';
        }
    }

    function filterByCategory(categoryId) {
        currentFilter = categoryId;

        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update URL
        if (categoryId) {
            window.history.pushState({}, '', `products.html?category=${categoryId}`);
        } else {
            window.history.pushState({}, '', 'products.html');
        }

        loadProducts();
    }

    async function addToCart(event, productId, maxQuantity) {
        event.preventDefault();

        if (!currentUser) {
            alert('Log in om producten toe te voegen aan de winkelwagen');
            window.location.href = 'login.html';
            return;
        }

        const form = event.target;
        const quantity = form.quantity.value;
        const startDate = form.startDate.value;
        const endDate = form.endDate.value;

        console.log('Adding to cart:', { productId, quantity, startDate, endDate });

        if (!startDate || !endDate) {
            alert('Selecteer start- en einddatum');
            return;
        }

        if (new Date(endDate) <= new Date(startDate)) {
            alert('Einddatum moet na startdatum liggen');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/cart/add?productId=${productId}&quantity=${quantity}&startDate=${startDate}&endDate=${endDate}`, {
                method: 'POST',
                credentials: 'include'
            });

            console.log('Response status:', response.status);

            if (response.ok) {
                const result = await response.json();
                console.log('Success:', result);
                alert('Product toegevoegd aan winkelwagen');
                updateCartCount();
                form.reset();
            } else {
                // Clone response to read it multiple times
                const clonedResponse = response.clone();
                let errorMessage = 'Fout bij toevoegen aan winkelwagen';

                try {
                    const error = await response.json();
                    errorMessage = error.error || errorMessage;
                } catch (e) {
                    const errorText = await clonedResponse.text();
                    console.error('Error text:', errorText);
                    errorMessage = errorText || errorMessage;
                }

                console.error('Error:', errorMessage);
                alert(errorMessage);
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            alert('Fout bij toevoegen aan winkelwagen: ' + error.message);
        }
    }
    // Load products on page load
    document.addEventListener('DOMContentLoaded', () => {
        checkAuthStatus();
        updateCartCount();
        loadProducts();
    });
</script>
</body>
</html>